<!doctype html>

<html lang="en">

<head>
  <title>The Working R Programmer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="Thomas Mailund" />
  <meta name="generator" content="Hugo 0.40.2" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

<link rel="stylesheet" type="text/css" href="https://mailund.github.io/r-programmer-blog/css/styles.css" />

 
       <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid Sans" type="text/css" media="all" />
     
       <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira Code" type="text/css" media="all" />
     

 <style>
 body {
     font-family: 'Droid Sans';
 }
 code {
    font-family: 'Fira Code'; 
 }
 </style>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-126024558-1', 'auto');
ga('send', 'pageview');
</script>

</head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://mailund.github.io/r-programmer-blog/">The Working R Programmer</a>
            </h1>

      <ul id="social-media">
        
        <li><a href="https://twitter.com/ThomasMailund"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://www.linkedin.com/in/thomas-mailund-94153b1"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://github.com/mailund"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a></li>
          
        <li><a href="https://www.facebook.com/mailund"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
          
        <li><a href="https://patreon.com/mailund"><i class="fab fa-patreon fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://www.goodreads.com/author/show/15484380.Thomas_Mailund"><i class="fab fa-goodreads fa-lg" aria-hidden="true"></i></a></li>
        
      </ul>
      
      <p><em>Tips and tricks for serious software development in R</em></p>
      

    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://mailund.github.io/r-programmer-blog/post/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://mailund.github.io/r-programmer-blog/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>Scoping Rules and NSE</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2018-09-20T05:00:15&#43;02:00">Sep 20, 2018</time>
        </li>
        
        
        <li>
            Categories: 
            <em>
                
                    
                    <a href="https://mailund.github.io/r-programmer-blog/categories/non-standard-evaluation/">Non-standard evaluation</a>
                
            </em>
        </li>
        

        
        <li>
            <em>
                
                    
                    <a href="https://mailund.github.io/r-programmer-blog/tags/scope-rules/">#scope-rules</a>
                
            </em>
        </li>
        

        <li>16 min read</li>
    </ul>
</aside>
    

    

<p>Earlier this week, I wrote some tweets about how you have to be careful about scopes when you do non-standard evaluation. I cover this in both <a href="https://amzn.to/2QHONDT"><em>Metaprogramming in R</em></a> and <a href="https://amzn.to/2QHMNLL"><em>Domain-Specific Languages in R</em></a>, but this tweet</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Comprehensive overview of NSE. Should be of interest to <a href="https://twitter.com/ThomasMailund?ref_src=twsrc%5Etfw">@ThomasMailund</a> <a href="https://twitter.com/MilesMcBain?ref_src=twsrc%5Etfw">@MilesMcBain</a> <a href="https://twitter.com/_ColinFay?ref_src=twsrc%5Etfw">@_ColinFay</a> and <a href="https://twitter.com/edwin_thoen?ref_src=twsrc%5Etfw">@edwin_thoen</a> <a href="https://t.co/2uI1HSnfEN">https://t.co/2uI1HSnfEN</a></p>&mdash; Deemah ðŸ‡ºðŸ‡¦  ðŸ‡³ðŸ‡´ (@dmi3k) <a href="https://twitter.com/dmi3k/status/1041563992332881920?ref_src=twsrc%5Etfw">September 17, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>made me write about it againâ€”only this time in a twitter thread.</p>

<p>Well, I say threadâ€”I don&rsquo;t actually know how to do that, it seams; I just replied to the tweet a bunch of times and apparently that doesn&rsquo;t make a thread, it therefore my reply was hard to read. This is apparently where I went wrong</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Sorry there is only one Tweet, remember you have to reply to one of the main tweet from the thread not a comment.<br>If you think I&#39;m buggy please let me know by DM or email ðŸ˜Š<br>Need help? check this link: <a href="https://t.co/dz8sHGkl3T">https://t.co/dz8sHGkl3T</a> ðŸ¤–</p>&mdash; Thread Reader App (@threadreaderapp) <a href="https://twitter.com/threadreaderapp/status/1041815478493229061?ref_src=twsrc%5Etfw">September 17, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>Anyway, the first tweet links to <a href="https://github.com/WinVector/wrapr/blob/master/extras/MacrosInR.md">this page</a> that contains a list of tools for implementing &ldquo;macros&rdquo; in R. This just means &ldquo;tools for substituting expressions into other expressions&rdquo; (preferably with some control over where they are put).<sup class="footnote-ref" id="fnref:macros"><a href="#fn:macros">1</a></sup> If you evaluate those expressions after the substitution, either right away or at some later time, it is also called <em>non-standard evaluation</em>. Not surprisingly, it is called that because it differs (at least it can differ) from standard evaluation where you simply have an expression and evaluate it.</p>

<p>The motivation for the <a href="https://github.com/WinVector/wrapr/blob/master/extras/MacrosInR.md">overview on macro methods</a> was apparently that a paper on <a href="https://cran.r-project.org/web/packages/wrapr/">the <code>wrapr</code> package</a> was rejected because it didn&rsquo;t compare the package with quasi-quotation from <a href="https://cran.r-project.org/web/packages/rlang/"><code>rlang</code></a>. I might be partially responsible for this, since I reviewed the paper, but I didn&rsquo;t complain about the lack of comparisonâ€”I complained that <code>wrapr</code> doesn&rsquo;t deal with scopes (which <code>rlang</code> does), and that this makes <code>wrapr</code>&rsquo;s <code>let</code> function very risky to use. You can <em>very</em> easily write a function that seems to work but contains subtle errors.</p>

<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Erh.. but the paper they had rejected â€” mentioned at the beginning â€” was reviewed by me :-/<br><br>There were some pretty serious issues with overscoping with their wrapr package. It doesnâ€™t handle it at all, so you very easily get some very hard to notice errorsâ€¦</p>&mdash; Thomas Mailund (@ThomasMailund) <a href="https://twitter.com/ThomasMailund/status/1041567698239606785?ref_src=twsrc%5Etfw">September 17, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">It occurs to me that my previous tweet makes it sound like there is something especially bad with wrapr. There isnâ€™t. But NSE is hard, and wrapr doesnâ€™t make it easier â€” just easier to get scoping wrong. I find that rlangâ€™s quosures does a good job (your mileage may vary). 1/</p>&mdash; Thomas Mailund (@ThomasMailund) <a href="https://twitter.com/ThomasMailund/status/1041677761130229761?ref_src=twsrc%5Etfw">September 17, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</p>

<p>Since I didn&rsquo;t manage to make my tweets into a proper thread, so they would be easy to read, I will try to repeat it here. I can add a few things here, now that I have a whole post to work with, but I cannot get around all the interesting scope and NSE topics I would like to. For that, I will send you to my books, or return to those topics at a later time.</p>

<p>Before I get started, though, I once more want to stress that <em>this is not an attack on wrapr::let!</em> The issues with scope are there for pretty much <a href="https://github.com/WinVector/wrapr/blob/master/extras/MacrosInR.md">all tools that manipulate expressions</a>. The <code>rlang</code> package has &ldquo;quosures&rdquo;â€”expressions plus scopesâ€”that alleviates many of the issues. This is the reason I prefer it over the others. If you do not explicitly handle scopes, you are likely to get into trouble with non-standard evaluation. Regardless of how you implement it.</p>

<p>I am simplifying a few things below to make the explanation easier; I am not describing what R <em>actually</em> does, but how it <em>conceptually</em> works with expressions and scopes. There are more details in it, but those are not relevant for this topic.</p>

<h2 id="the-rules-for-expressions-and-evaluation">The rules for expressions and evaluation</h2>

<p>Whenever you write an expression in R, you create an expression object, an abstract syntax tree if you will, and then evaluates it.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">x &lt;- <span style="color:#3677a9">2</span> ; y &lt;- <span style="color:#3677a9">1</span> ; z &lt;- <span style="color:#3677a9">3</span>
x * (y + z)</code></pre></div>
<pre><code>## [1] 8
</code></pre>

<p>You do not <em>have</em> to evaluate it, though. You can avoid this by <em>quoting</em> the expression</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">quote</span>(x * (y + z))</code></pre></div>
<pre><code>## x * (y + z)
</code></pre>

<p>This gives you the abstract syntax tree instead of the result of evaluating it.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">expr &lt;- <span style="color:#6ab825">quote</span>(x * (y + z))
<span style="color:#6ab825">class</span>(expr)</code></pre></div>
<pre><code>## [1] &quot;call&quot;
</code></pre>

<p>In this particular case, it says that the syntax tree is a <em>call</em>. It is, because <code>*</code> is a function and that is what we are calling at the outermost level. There are other kinds an expression can be, e.g. constants and variables, but for this post that doesn&rsquo;t matter. What matters is that you can create non-evaluated (quoted) expressions.</p>

<p>That, alone, isn&rsquo;t that interesting. The interesting part is that you can:</p>

<ol>
<li>Evaluate expressions later, in alternative scopes,</li>
<li>You can manipulate expressions and modify them before you evaluate them.</li>
</ol>

<p>You evaluate an expression using the <code>eval</code> function</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">eval</span>(expr)</code></pre></div>
<pre><code>## [1] 8
</code></pre>

<p>and you can modify it in several ways; one way is using the built-in <code>substitute</code> function</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">expr2 &lt;- <span style="color:#6ab825">substitute</span>(x * (y + z), <span style="color:#6ab825;font-weight:bold">list</span>(x = <span style="color:#3677a9">42</span>))
expr2</code></pre></div>
<pre><code>## 42 * (y + z)
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">eval</span>(expr2)</code></pre></div>
<pre><code>## [1] 168
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">12345</span>)

<span style="color:#999;font-style:italic"># Data:</span>
d1 &lt;- <span style="color:#6ab825;font-weight:bold">data.frame</span>(x = rnorm(<span style="color:#3677a9">5</span>), y = rnorm(<span style="color:#3677a9">5</span>))
d2 &lt;- <span style="color:#6ab825;font-weight:bold">data.frame</span>(a = rnorm(<span style="color:#3677a9">5</span>), b = rnorm(<span style="color:#3677a9">5</span>))

<span style="color:#999;font-style:italic"># Not unreasonable usage:</span>
<span style="color:#6ab825">summary</span>(lm(y ~ x, data = d1))[[<span style="color:#ed9d13">&#34;residuals&#34;</span>]]</code></pre></div>
<pre><code>##           1           2           3           4           5 
## -1.19510172  1.28778546  0.15138692  0.04667528 -0.29074594
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(b ~ a, data = d2))[[<span style="color:#ed9d13">&#34;residuals&#34;</span>]]</code></pre></div>
<pre><code>##          1          2          3          4          5 
##  0.3655564 -0.3493650 -0.5340553  0.9946969 -0.4768330
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">xx &lt;- rnorm(<span style="color:#3677a9">5</span>) <span style="color:#999;font-style:italic"># for partial over-scoping</span>
<span style="color:#6ab825">summary</span>(lm(y ~ xx, data = d1))[[<span style="color:#ed9d13">&#34;residuals&#34;</span>]]</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -1.3927303  0.9882521  0.2902905  0.3724643 -0.2582766
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(b ~ xx, data = d2))[[<span style="color:#ed9d13">&#34;residuals&#34;</span>]]</code></pre></div>
<pre><code>##          1          2          3          4          5 
##  0.9484049 -0.5472260 -0.6373186  0.5359077 -0.2997679
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># Parameterise:</span>
lm_prop &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(x, y, d, prop) {
    m &lt;- lm(y ~ x, data = d)
    <span style="color:#6ab825">summary</span>(m)[[prop]]
}
lm_prop(x, y, d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>)</code></pre></div>
<pre><code>##           1           2           3           4           5 
## -1.19510172  1.28778546  0.15138692  0.04667528 -0.29074594
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># lm_prop(a, b, d2, &#34;residuals&#34;)</span>
<span style="color:#999;font-style:italic"># -&gt; Error: a and b do not exist; we need NSE for this</span>

<span style="color:#6ab825;font-weight:bold">library</span>(wrapr)</code></pre></div>
<pre><code>## Error in library(wrapr): there is no package called 'wrapr'
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop2 &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(x, y, d, prop, <span style="color:#6ab825">eval</span>) {
    let(<span style="color:#6ab825;font-weight:bold">c</span>(x = x, y = y, prop = prop),
        <span style="color:#6ab825">summary</span>(lm(y ~ x, data = d))$prop,
        eval = <span style="color:#6ab825">eval</span>)
}

<span style="color:#999;font-style:italic"># Complete overscoping</span>
lm_prop2(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(y ~ x, data = d1))$residuals</code></pre></div>
<pre><code>##           1           2           3           4           5 
## -1.19510172  1.28778546  0.15138692  0.04667528 -0.29074594
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop2(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># Partial overscoping</span>
lm_prop2(<span style="color:#ed9d13">&#34;xx&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop2(<span style="color:#ed9d13">&#34;xx&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(y ~ xx, data = d1))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -1.3927303  0.9882521  0.2902905  0.3724643 -0.2582766
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># Complete overscoping</span>
lm_prop2(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(b ~ a, data = d2))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
##  0.3655564 -0.3493650 -0.5340553  0.9946969 -0.4768330
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop2(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># Partial overscoping</span>
lm_prop2(<span style="color:#ed9d13">&#34;xx&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(b ~ xx, data = d2))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
##  0.9484049 -0.5472260 -0.6373186  0.5359077 -0.2997679
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop2(<span style="color:#ed9d13">&#34;xx&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># -&gt; Works as intended!</span>

<span style="color:#999;font-style:italic"># What if I used a different variable for the partial</span>
<span style="color:#999;font-style:italic"># overscoping -- that should also work</span>
x &lt;- a &lt;- xx
lm_prop2(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(y ~ a, data = d1))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -1.3927303  0.9882521  0.2902905  0.3724643 -0.2582766
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop2(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop2(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = x, y = y, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(b ~ x, data = d2))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
##  0.9484049 -0.5472260 -0.6373186  0.5359077 -0.2997679
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># lm_prop2(&#34;x&#34;, &#34;b&#34;, d2, &#34;residuals&#34;, eval = TRUE)</span>
<span style="color:#999;font-style:italic"># -&gt; Error: in expression, x is the *string* &#34;x&#34;</span>
<span style="color:#999;font-style:italic">#    At least we get an error</span>

<span style="color:#999;font-style:italic"># Fix: don&#39;t substitute with the same name?</span>
lm_prop3 &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(a, b, d, prop, <span style="color:#6ab825">eval</span>) {
    let(<span style="color:#6ab825;font-weight:bold">c</span>(x = a, y = b, prop = prop),
        <span style="color:#6ab825">summary</span>(lm(y ~ x, data = d))$prop,
        eval = <span style="color:#6ab825">eval</span>)
}
lm_prop3(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = a, y = b, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(b ~ x, data = d2))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
##  0.9484049 -0.5472260 -0.6373186  0.5359077 -0.2997679
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop3(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = a, y = b, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop3(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>,  d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = a, y = b, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(y ~ a, data = d1))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -1.3927303  0.9882521  0.2902905  0.3724643 -0.2582766
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># lm_prop3(&#34;a&#34;, &#34;y&#34;,  d1, &#34;residuals&#34;, eval = TRUE)</span>
<span style="color:#999;font-style:italic"># -&gt; Error: even if we do not use it to substitute,</span>
<span style="color:#999;font-style:italic">#    then a is still a local variable.</span>
<span style="color:#999;font-style:italic">#    We *cannot* call this function with names</span>
<span style="color:#999;font-style:italic">#    that can be local variables!</span>


<span style="color:#999;font-style:italic"># Avoid any conflict btw args and local variables</span>
lm_prop4 &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(<span style="color:#3677a9">.</span>a, <span style="color:#3677a9">.</span>b, d, prop, <span style="color:#6ab825">eval</span>) {
    let(<span style="color:#6ab825;font-weight:bold">c</span>(x = <span style="color:#3677a9">.</span>a, y = <span style="color:#3677a9">.</span>b, prop = prop),
        <span style="color:#6ab825">summary</span>(lm(y ~ x, data = d))$prop,
        eval = <span style="color:#6ab825">eval</span>)
}
lm_prop4(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>,  d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(y ~ a, data = d1))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -1.3927303  0.9882521  0.2902905  0.3724643 -0.2582766
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop4(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>,  d1, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop4(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(b ~ x, data = d2))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
##  0.9484049 -0.5472260 -0.6373186  0.5359077 -0.2997679
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop4(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, d2, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, prop = prop), summary(lm(y ~ x, data = d))$prop, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># All is well!</span>

<span style="color:#999;font-style:italic"># What if we had done this?</span>
lm_prop5 &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(<span style="color:#3677a9">.</span>a, <span style="color:#3677a9">.</span>b, <span style="color:#3677a9">.</span>d, prop, <span style="color:#6ab825">eval</span>) {
    let(<span style="color:#6ab825;font-weight:bold">c</span>(x = <span style="color:#3677a9">.</span>a, y = <span style="color:#3677a9">.</span>b, d = <span style="color:#3677a9">.</span>d, prop = prop),
        <span style="color:#6ab825">summary</span>(lm(y ~ x, data = d))$prop,
        eval = <span style="color:#6ab825">eval</span>)
}
lm_prop5(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>,  <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, d = .d, prop = prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(y ~ a, data = d1))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -1.3927303  0.9882521  0.2902905  0.3724643 -0.2582766
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop5(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>,  <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, d = .d, prop = prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop5(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>,  <span style="color:#ed9d13">&#34;d2&#34;</span>, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, d = .d, prop = prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">summary</span>(lm(b ~ x, data = d2))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
##  0.9484049 -0.5472260 -0.6373186  0.5359077 -0.2997679
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_prop5(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>,  <span style="color:#ed9d13">&#34;d2&#34;</span>, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, d = .d, prop = prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># Great!?</span>

indirect &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(xx, yy, <span style="color:#6ab825">eval</span>) {
    d &lt;- <span style="color:#6ab825;font-weight:bold">data.frame</span>(x = xx, y = yy)
    lm_prop5(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, <span style="color:#ed9d13">&#34;d&#34;</span>, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825">eval</span>)
}

aa &lt;- rnorm(<span style="color:#3677a9">5</span>) ; bb &lt;- rnorm(<span style="color:#3677a9">5</span>)
<span style="color:#6ab825">summary</span>(lm(bb ~ aa))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -0.2855751  0.5968646  0.6913960  0.2728369 -1.2755224
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">indirect(aa, bb, eval = <span style="color:#6ab825;font-weight:bold">FALSE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, d = .d, prop = prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">indirect(aa, bb, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>)</code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, d = .d, prop = prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># -&gt; Error: d isn&#39;t known (it is in the wrong scope)</span>

d &lt;- d1 <span style="color:#999;font-style:italic"># what would have happened if we had a global d?</span>
indirect(aa, bb, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>) <span style="color:#999;font-style:italic"># no error, but wrong result!</span></code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, d = .d, prop = prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># You get:</span>
<span style="color:#6ab825">summary</span>(lm(y ~ x, data = d1))$residuals</code></pre></div>
<pre><code>##           1           2           3           4           5 
## -1.19510172  1.28778546  0.15138692  0.04667528 -0.29074594
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># You expected:</span>
<span style="color:#6ab825">summary</span>(lm(bb ~ aa))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -0.2855751  0.5968646  0.6913960  0.2728369 -1.2755224
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># The problem is that the d variable is found in the</span>
<span style="color:#999;font-style:italic"># global scope and not the calling scope. Fix:</span>
lm_prop6 &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(<span style="color:#3677a9">.</span>a, <span style="color:#3677a9">.</span>b, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop, <span style="color:#6ab825">eval</span>) {
    let(<span style="color:#6ab825;font-weight:bold">c</span>(x = <span style="color:#3677a9">.</span>a, y = <span style="color:#3677a9">.</span>b, d = <span style="color:#3677a9">.</span>d, prop = <span style="color:#3677a9">.</span>prop),
        <span style="color:#6ab825">summary</span>(lm(y ~ x, data = d))$prop,
        envir = <span style="color:#6ab825">parent.frame</span>(),
        eval = <span style="color:#6ab825">eval</span>)
}
indirect2 &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(xx, yy, <span style="color:#6ab825">eval</span>) {
    d &lt;- <span style="color:#6ab825;font-weight:bold">data.frame</span>(x = xx, y = yy)
    lm_prop6(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, <span style="color:#ed9d13">&#34;d&#34;</span>, <span style="color:#ed9d13">&#34;residuals&#34;</span>, eval = <span style="color:#6ab825">eval</span>)
}
<span style="color:#6ab825">summary</span>(lm(bb ~ aa))$residuals</code></pre></div>
<pre><code>##          1          2          3          4          5 
## -0.2855751  0.5968646  0.6913960  0.2728369 -1.2755224
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">indirect2(aa, bb, eval = <span style="color:#6ab825;font-weight:bold">TRUE</span>) <span style="color:#999;font-style:italic"># Fixed!</span></code></pre></div>
<pre><code>## Error in let(c(x = .a, y = .b, d = .d, prop = .prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic">## New example...</span>
<span style="color:#6ab825">rm</span>(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;aa&#34;</span>, <span style="color:#ed9d13">&#34;bb&#34;</span>, <span style="color:#ed9d13">&#34;xx&#34;</span>)
model_prop &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(<span style="color:#3677a9">.</span>x, <span style="color:#3677a9">.</span>y, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop) {
    let(<span style="color:#6ab825;font-weight:bold">c</span>(x = <span style="color:#3677a9">.</span>x, y = <span style="color:#3677a9">.</span>y, d = <span style="color:#3677a9">.</span>d, prop = <span style="color:#3677a9">.</span>prop),
        <span style="color:#6ab825">summary</span>(lm(y ~ x, data = d))$prop,
        envir = <span style="color:#6ab825">parent.frame</span>())
}
<span style="color:#999;font-style:italic"># This works both with global variables</span>
<span style="color:#999;font-style:italic"># and variables in the calling scope</span>

<span style="color:#999;font-style:italic"># Now let us use it...</span>
<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>)
ylen &lt;- <span style="color:#6ab825">with</span>(d1, <span style="color:#6ab825">length</span>(y))
<span style="color:#3677a9">.</span>z &lt;- rnorm(ylen)
<span style="color:#6ab825;font-weight:bold">list</span>(xy = model_prop(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>),
     xz = model_prop(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;.z&#34;</span>, <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>))</code></pre></div>
<pre><code>## Error in let(c(x = .x, y = .y, d = .d, prop = .prop), summary(lm(y ~ x, : could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># Parameterise</span>
<span style="color:#6ab825">rm</span>(<span style="color:#ed9d13">&#34;ylen&#34;</span>, <span style="color:#ed9d13">&#34;.z&#34;</span>)
xyz &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(<span style="color:#3677a9">.</span>x, <span style="color:#3677a9">.</span>y, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop) {
    let(<span style="color:#6ab825;font-weight:bold">c</span>(d = <span style="color:#3677a9">.</span>d, x = <span style="color:#3677a9">.</span>x, y = <span style="color:#3677a9">.</span>y),
        {
            ylen &lt;- <span style="color:#6ab825">with</span>(d, <span style="color:#6ab825">length</span>(y))
            <span style="color:#3677a9">.</span>z &lt;- rnorm(ylen)
            <span style="color:#999;font-style:italic"># NB: don&#39;t mess up the parameters here</span>
            <span style="color:#999;font-style:italic"># You cannot use the substituted and you</span>
            <span style="color:#999;font-style:italic"># have to use &#34;.z&#34; as string</span>
            <span style="color:#6ab825;font-weight:bold">list</span>(xy = model_prop(<span style="color:#3677a9">.</span>x, <span style="color:#3677a9">.</span>y, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop),
                 xz = model_prop(<span style="color:#3677a9">.</span>x, <span style="color:#ed9d13">&#34;.z&#34;</span>, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop))
        })
}

<span style="color:#999;font-style:italic"># works with overscoping</span>
<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, <span style="color:#ed9d13">&#34;d2&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># works with global vars.</span>
xx &lt;- d1$x ; yy &lt;- d1$y
<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;xx&#34;</span>, <span style="color:#ed9d13">&#34;yy&#34;</span>, <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;xx&#34;</span>, <span style="color:#ed9d13">&#34;yy&#34;</span>, <span style="color:#ed9d13">&#34;d2&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># works with partial overscoping</span>
<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;xx&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;yy&#34;</span>, <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;xx&#34;</span>, <span style="color:#ed9d13">&#34;b&#34;</span>, <span style="color:#ed9d13">&#34;d2&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;a&#34;</span>, <span style="color:#ed9d13">&#34;yy&#34;</span>, <span style="color:#ed9d13">&#34;d2&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">xyz_df &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(d, prop) xyz(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, <span style="color:#ed9d13">&#34;d&#34;</span>, prop)
<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz_df(d1, <span style="color:#ed9d13">&#34;r.squared&#34;</span>) </code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># We get the same result, so this should be fine?!??</span>
<span style="color:#999;font-style:italic"># Wrong, the function finds the global d; it doesn&#39;t use d1</span>
<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">4321</span>) ; d &lt;- <span style="color:#6ab825;font-weight:bold">data.frame</span>(x = rnorm(<span style="color:#3677a9">5</span>), y = rnorm(<span style="color:#3677a9">5</span>))

<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz_df(d1, <span style="color:#ed9d13">&#34;r.squared&#34;</span>) </code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">4123</span>) ; d &lt;- <span style="color:#6ab825;font-weight:bold">data.frame</span>(x = rnorm(<span style="color:#3677a9">5</span>), y = rnorm(<span style="color:#3677a9">5</span>))
<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz_df(d1, <span style="color:#ed9d13">&#34;r.squared&#34;</span>) </code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#999;font-style:italic"># Oops, we use the global d and not d1!</span>


xyz &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(<span style="color:#3677a9">.</span>x, <span style="color:#3677a9">.</span>y, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop) {
    let(<span style="color:#6ab825;font-weight:bold">c</span>(d = <span style="color:#3677a9">.</span>d, x = <span style="color:#3677a9">.</span>x, y = <span style="color:#3677a9">.</span>y),
        {
            ylen &lt;- <span style="color:#6ab825">with</span>(d, <span style="color:#6ab825">length</span>(y))
            <span style="color:#3677a9">.</span>z &lt;- rnorm(ylen)
            <span style="color:#999;font-style:italic"># NB: don&#39;t mess up the parameters here</span>
            <span style="color:#999;font-style:italic"># You cannot use the substituted and you</span>
            <span style="color:#999;font-style:italic"># have to use &#34;.z&#34; as string</span>
            <span style="color:#6ab825;font-weight:bold">list</span>(xy = model_prop(<span style="color:#3677a9">.</span>x, <span style="color:#3677a9">.</span>y, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop),
                 xz = model_prop(<span style="color:#3677a9">.</span>x, <span style="color:#ed9d13">&#34;.z&#34;</span>, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop))
        },
        envir = <span style="color:#6ab825">parent.frame</span>())
}
<span style="color:#999;font-style:italic"># set.seed(1234) ; xyz_df(d1, &#34;r.squared&#34;) </span>
<span style="color:#999;font-style:italic"># -&gt; Error: now it doesn&#39;t know .x (fair enough, it is a local var)</span>


xyz &lt;- <span style="color:#6ab825;font-weight:bold">function</span>(<span style="color:#3677a9">.</span>x, <span style="color:#3677a9">.</span>y, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop) {
    <span style="color:#999;font-style:italic"># we need to chain environments...</span>
    my_env &lt;- <span style="color:#6ab825">environment</span>()
    <span style="color:#6ab825">parent.env</span>(my_env) &lt;- <span style="color:#6ab825">parent.frame</span>()
    let(<span style="color:#6ab825;font-weight:bold">c</span>(d = <span style="color:#3677a9">.</span>d, x = <span style="color:#3677a9">.</span>x, y = <span style="color:#3677a9">.</span>y),
        {
            ylen &lt;- <span style="color:#6ab825">with</span>(d, <span style="color:#6ab825">length</span>(y))
            <span style="color:#3677a9">.</span>z &lt;- rnorm(ylen)
            <span style="color:#999;font-style:italic"># NB: don&#39;t mess up the parameters here</span>
            <span style="color:#999;font-style:italic"># You cannot use the substituted and you</span>
            <span style="color:#999;font-style:italic"># have to use &#34;.z&#34; as string</span>
            <span style="color:#6ab825;font-weight:bold">list</span>(xy = model_prop(<span style="color:#3677a9">.</span>x, <span style="color:#3677a9">.</span>y, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop),
                 xz = model_prop(<span style="color:#3677a9">.</span>x, <span style="color:#ed9d13">&#34;.z&#34;</span>, <span style="color:#3677a9">.</span>d, <span style="color:#3677a9">.</span>prop))
        },
        envir = my_env)
}
<span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz_df(d1, <span style="color:#ed9d13">&#34;r.squared&#34;</span>) </code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6ab825">set.seed</span>(<span style="color:#3677a9">1234</span>) ; xyz(<span style="color:#ed9d13">&#34;x&#34;</span>, <span style="color:#ed9d13">&#34;y&#34;</span>, <span style="color:#ed9d13">&#34;d1&#34;</span>, <span style="color:#ed9d13">&#34;r.squared&#34;</span>)</code></pre></div>
<pre><code>## Error in let(c(d = .d, x = .x, y = .y), {: could not find function &quot;let&quot;
</code></pre>

<hr/>

<p><small>If you liked what you read, and want more like it, consider supporting me at <a href="https://www.patreon.com/mailund">Patreon</a>.</small>
<hr/></p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:macros">I don&rsquo;t like the term macro here, because to me it sounds like something that would happen at compile time (which in R would be when you translate code into bytecode). This doesn&rsquo;t happen. There is no way (that I am aware of) to implement your own syntactic sugar that doesn&rsquo;t involve evaluating code at runtime.
 <a class="footnote-return" href="#fnref:macros"><sup>[return]</sup></a></li>
</ol>
</div>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://mailund.github.io/r-programmer-blog/2018/04/27/new-package-releases-foolbox-and-tailr/"><i class="fa fa-chevron-circle-left"></i> New Package Releases: foolbox and tailr</a>
        </li>
        
        
    </ul>
</section>
    
        <section class="comments-block">
      <button id="show-comments" style="display: none;"><i class="fa fa-comments-o"></i> Add/View Comments</button>
</section>

<section id="disqus_thread"></section>

<script>
      (function () {
            
            
            if (window.location.hostname == "localhost")
                  return;

            var disqus_loaded = false;
            var disqus_shortname = 'r-programmer-blog';
            var disqus_button = document.getElementById("show-comments");

            disqus_button.style.display = "";
            disqus_button.addEventListener("click", disqus, false);

            function disqus() {

                  if (!disqus_loaded) {
                        disqus_loaded = true;

                        var e = document.createElement("script");
                        e.type = "text/javascript";
                        e.async = true;
                        e.src = "//" + disqus_shortname + ".disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] ||
                              document.getElementsByTagName("body")[0])
                        .appendChild(e);

                        
                        document.getElementById("show-comments").style.display = "none";
                  }
            }

            
            var hash = window.location.hash.substr(1);
            if (hash.length > 8) {
                  if (hash.substring(0, 8) == "comment-") {
                        disqus();
                  }
            }

            
            if (/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)) {
                  disqus();
            }
      })();
</script>
    





</main>
    <footer>
        <h6>Copyright &copy; 2018 - Thomas Mailund | 
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://mailund.github.io/r-programmer-blog/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="https://mailund.github.io/r-programmer-blog/js/scripts.js"></script>
</body>
<div id="amzn-assoc-ad-04956520-8388-43ab-9b6e-fbe758d208f8"></div>
<script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=04956520-8388-43ab-9b6e-fbe758d208f8"></script>

</html>